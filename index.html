<!DOCTYPE html>
<html lang="en">
  <head>
    <!--
      Pathfinder GM Toolkit - Dashboard
      Purpose: Provide a focused dashboard view for core GM tools.
    -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pathfinder GM Toolkit</title>
    <style>
      :root {
        /* Brand palette tuned for Pathfinder dark mode styling. */
        --parchment: #f3e4c3;
        --parchment-dark: #cdb78a;
        --parchment-night: #2a2218;
        --parchment-shadow: #1d170f;
        --ink: #f5ead3;
        --ink-muted: #c7b79a;
        --crimson: #b02a2a;
        --crimson-dark: #7a1414;
        --gold: #c9a24a;
        --gold-bright: #e8c877;
        --shadow: rgba(8, 6, 4, 0.55);
        --success: #6bb36f;
        --warning: #e3a042;
        /* Typography stack */
        --serif: "Georgia", "Times New Roman", serif;
        --sans: "Trebuchet MS", "Segoe UI", sans-serif;
      }

      /* Global reset and base typography */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--sans);
        color: var(--ink);
        background: radial-gradient(circle at top, #3a2f22 0%, var(--parchment-night) 55%, #140f0a 100%);
        line-height: 1.6;
      }

      /* Centered layout container */
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 1.5rem;
      }

      /* Header banner for dashboard context (compact for dense GM workflows). */
      .dashboard-header {
        padding: 1.6rem 0 1.2rem;
      }

      .header-frame {
        background: linear-gradient(140deg, rgba(42, 34, 24, 0.95), rgba(31, 23, 16, 0.9));
        border-radius: 18px;
        padding: 1.4rem 1.8rem;
        box-shadow: 0 18px 32px var(--shadow);
        border: 2px solid var(--gold);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .sigil {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: linear-gradient(160deg, var(--crimson), var(--crimson-dark));
        display: grid;
        place-items: center;
        color: var(--gold-bright);
        font-family: var(--serif);
        font-size: 1.4rem;
        font-weight: 700;
        letter-spacing: 1px;
        box-shadow: 0 10px 18px var(--shadow);
      }

      .dashboard-header h1 {
        font-family: var(--serif);
        font-size: clamp(1.7rem, 2.4vw, 2.4rem);
      }

      .dashboard-header p {
        margin-top: 0.4rem;
        max-width: 640px;
        color: var(--ink-muted);
      }

      /* Quick snapshot cards */
      .snapshots {
        display: grid;
        gap: 0.8rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        margin-top: 1rem;
      }

      .snapshot-card {
        background: rgba(38, 30, 22, 0.95);
        border-radius: 14px;
        padding: 0.9rem 1.1rem;
        border: 1px solid rgba(201, 162, 74, 0.4);
        box-shadow: 0 12px 20px var(--shadow);
      }

      .snapshot-card h3 {
        font-family: var(--serif);
        color: var(--gold-bright);
        margin-bottom: 0.4rem;
      }

      /* Dashboard main grid */
      .dashboard-main {
        padding: 1.5rem 0 3.5rem;
      }

      .dashboard-grid {
        display: grid;
        gap: 2rem;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      }

      /* Tool grid styles */
      .tool-grid {
        display: grid;
        gap: 1.2rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .tool-card {
        background: rgba(32, 25, 18, 0.92);
        border-radius: 16px;
        padding: 1.4rem;
        border-left: 6px solid var(--crimson);
        box-shadow: 0 12px 20px var(--shadow);
      }

      .tool-card--action {
        width: 100%;
        border: none;
        text-align: left;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
        padding: 1.4rem;
        background: rgba(32, 25, 18, 0.92);
        color: inherit;
      }

      .tool-card--action:hover,
      .tool-card--action:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 16px 26px var(--shadow);
        outline: none;
      }

      .tool-card h3 {
        margin-bottom: 0.5rem;
        font-family: var(--serif);
        color: var(--gold-bright);
      }

      .tool-card p {
        margin-bottom: 0.8rem;
      }

      .tool-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 0.85rem;
      }

      .tool-tag {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: rgba(201, 162, 74, 0.2);
        color: var(--ink-muted);
      }

      .tool-launch {
        margin-top: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: transparent;
        color: var(--gold-bright);
        border: 1px dashed rgba(201, 162, 74, 0.7);
      }

      /* Side panels for notes and status */
      .side-panel {
        background: rgba(34, 26, 19, 0.94);
        border-radius: 18px;
        padding: 1.6rem;
        border: 1px dashed rgba(201, 162, 74, 0.6);
        box-shadow: 0 10px 18px var(--shadow);
      }

      .side-panel + .side-panel {
        margin-top: 1.5rem;
      }

      .side-panel h2 {
        font-family: var(--serif);
        margin-bottom: 0.8rem;
      }

      .panel-list {
        list-style: none;
        display: grid;
        gap: 0.75rem;
      }

      .panel-item {
        background: rgba(26, 20, 14, 0.9);
        border-radius: 12px;
        padding: 0.7rem 0.9rem;
        border-left: 4px solid var(--gold);
      }

      /* Initiative tracker layout (compact header to emphasize workspace). */
      .initiative-module {
        padding: 1.6rem 0 3rem;
      }

      .module-header {
        background: rgba(33, 25, 18, 0.95);
        border-radius: 16px;
        padding: 1.1rem 1.4rem;
        border: 2px solid var(--gold);
        box-shadow: 0 16px 28px var(--shadow);
      }

      .module-header h2 {
        font-family: var(--serif);
        margin-bottom: 0.4rem;
      }

      .module-actions {
        margin-top: 0.7rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
      }

      .initiative-tracker {
        margin: 1.4rem 0 0;
        background: rgba(28, 22, 16, 0.92);
        border-radius: 18px;
        padding: 1.4rem;
        border: 2px solid var(--gold);
        box-shadow: 0 18px 28px var(--shadow);
      }

      .initiative-tracker h2 {
        font-family: var(--serif);
        margin-bottom: 0.4rem;
      }

      .tracker-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 1.5rem;
        margin-top: 1.1rem;
      }

      .tracker-panel {
        background: rgba(36, 28, 20, 0.96);
        border-radius: 16px;
        padding: 1.2rem;
        border: 1px solid rgba(201, 162, 74, 0.35);
      }

      .tracker-panel h3 {
        font-family: var(--serif);
        margin-bottom: 0.8rem;
      }

      .field-row {
        display: grid;
        gap: 0.8rem;
        grid-template-columns: minmax(0, 1fr) 140px 120px;
        align-items: end;
      }

      label {
        font-weight: 600;
      }

      input,
      select,
      button,
      textarea {
        font-family: inherit;
        font-size: 0.95rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.55rem 0.65rem;
        border-radius: 10px;
        border: 1px solid rgba(201, 162, 74, 0.45);
        background: rgba(20, 16, 12, 0.9);
        color: var(--ink);
      }

      button {
        border: none;
        border-radius: 10px;
        padding: 0.6rem 1rem;
        cursor: pointer;
        background: var(--crimson);
        color: #fff;
        font-weight: 600;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px var(--shadow);
      }

      button.secondary {
        background: rgba(201, 162, 74, 0.18);
        color: var(--ink);
        border: 1px solid rgba(201, 162, 74, 0.5);
      }

      button.ghost {
        background: transparent;
        border: 1px dashed rgba(201, 162, 74, 0.7);
        color: var(--gold-bright);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .participant-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      .participant-table th,
      .participant-table td {
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid rgba(201, 162, 74, 0.35);
        text-align: left;
        vertical-align: top;
      }

      .participant-table th {
        font-family: var(--serif);
      }

      .participant-row.active {
        background: rgba(176, 42, 42, 0.2);
        border-left: 4px solid var(--crimson);
      }

      .marker-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 0.4rem;
      }

      .marker-chip {
        background: rgba(201, 162, 74, 0.15);
        border: 1px solid rgba(201, 162, 74, 0.45);
        padding: 0.25rem 0.45rem;
        border-radius: 999px;
        display: inline-flex;
        gap: 0.35rem;
        align-items: center;
        font-size: 0.82rem;
      }

      .marker-chip button {
        background: transparent;
        border: none;
        color: var(--crimson);
        padding: 0;
        font-size: 0.9rem;
      }

      .initiative-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        margin-top: 1rem;
        align-items: center;
      }

      .status-pill {
        background: rgba(107, 179, 111, 0.2);
        color: var(--success);
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
        border: 1px solid rgba(107, 179, 111, 0.4);
      }

      .round-display {
        font-weight: 700;
        color: var(--gold-bright);
      }

      .helper-text {
        font-size: 0.85rem;
        color: var(--ink-muted);
      }

      .legend {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        margin-top: 0.6rem;
      }

      .legend span {
        background: rgba(201, 162, 74, 0.2);
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        font-size: 0.78rem;
      }

      /* Modal (lightbox) styling */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(22, 16, 11, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1.5rem;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: rgba(33, 25, 18, 0.98);
        border-radius: 18px;
        padding: 1.6rem;
        max-width: 720px;
        width: 100%;
        box-shadow: 0 20px 40px var(--shadow);
        border: 2px solid var(--gold);
      }

      .modal h3 {
        font-family: var(--serif);
        margin-bottom: 0.6rem;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.6rem;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .modal-list {
        display: grid;
        gap: 0.8rem;
        max-height: 340px;
        overflow: auto;
        padding-right: 0.4rem;
      }

      .modal-item {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 120px;
        gap: 0.8rem;
        align-items: center;
        padding: 0.5rem 0.7rem;
        border-radius: 12px;
        border: 1px solid rgba(201, 162, 74, 0.4);
        background: rgba(20, 16, 12, 0.9);
      }

      .notice {
        background: rgba(227, 160, 66, 0.18);
        border-left: 4px solid var(--warning);
        padding: 0.6rem 0.8rem;
        border-radius: 10px;
        margin-top: 0.6rem;
        font-size: 0.88rem;
      }

      .is-hidden {
        display: none;
      }

      /* Footer for thematic close */
      footer {
        background: var(--crimson-dark);
        color: var(--ink);
        padding: 1.2rem 0;
        text-align: center;
        font-size: 0.95rem;
      }

      @media (max-width: 920px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .tracker-grid {
          grid-template-columns: 1fr;
        }

        .field-row {
          grid-template-columns: 1fr;
        }

        .modal-item {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Dashboard header with product identity and quick context -->
    <header class="dashboard-header">
      <div class="container header-frame">
        <div class="brand">
          <div class="sigil" aria-hidden="true">PF</div>
          <div>
            <p style="text-transform: uppercase; letter-spacing: 0.2em; font-size: 0.75rem;">
              Pathfinder Game Master Toolkit
            </p>
            <h1>GM Command Dashboard</h1>
          </div>
        </div>
        <p>
          Jump straight into session prep, encounter building, and table management with a unified
          set of GM tools.
        </p>
        <div class="snapshots">
          <div class="snapshot-card">
            <h3>Tonight's Session</h3>
            <p>Chapter 4: The Midnight Vault</p>
            <p><strong>Players:</strong> 5 | <strong>Est. runtime:</strong> 3 hrs</p>
          </div>
          <div class="snapshot-card">
            <h3>Prep Queue</h3>
            <p>2 encounters, 3 NPCs, 1 travel montage</p>
            <p><strong>Next:</strong> Finalize vault traps</p>
          </div>
          <div class="snapshot-card">
            <h3>Campaign Health</h3>
            <p>Story beats on track. 1 open quest thread.</p>
            <p><strong>Reminder:</strong> Award milestone XP</p>
          </div>
        </div>
      </div>
    </header>

    <!-- Main dashboard area with tool access and status panels -->
    <main class="dashboard-main" id="dashboard-view">
      <div class="container dashboard-grid">
        <section aria-label="GM tool dashboard">
          <h2 style="font-family: var(--serif); margin-bottom: 1rem;">Core GM Tools</h2>
          <div class="tool-grid">
            <article class="tool-card">
              <h3>Encounter Builder</h3>
              <p>Balance fights, adjust difficulty, and auto-calc XP budgets.</p>
              <div class="tool-meta">
                <span class="tool-tag">Combat</span>
                <span class="tool-tag">XP</span>
              </div>
            </article>
            <article class="tool-card">
              <h3>NPC Vault</h3>
              <p>Store allies and villains with roleplay prompts and stat notes.</p>
              <div class="tool-meta">
                <span class="tool-tag">Social</span>
                <span class="tool-tag">Lore</span>
              </div>
            </article>
            <article class="tool-card">
              <h3>Treasure Generator</h3>
              <p>Roll loot tables and print item cards for quick handouts.</p>
              <div class="tool-meta">
                <span class="tool-tag">Loot</span>
                <span class="tool-tag">Handouts</span>
              </div>
            </article>
            <button
              class="tool-card tool-card--action"
              type="button"
              id="initiative-launch"
              aria-label="Open Initiative Tracker module"
            >
              <h3>Initiative Tracker</h3>
              <p>Track turn order, conditions, and persistent damage rounds.</p>
              <div class="tool-meta">
                <span class="tool-tag">Combat</span>
                <span class="tool-tag">Timing</span>
              </div>
              <span class="tool-launch">Open Tracker →</span>
            </button>
            <article class="tool-card">
              <h3>Session Notes</h3>
              <p>Capture scenes, rulings, and retcons with searchable tags.</p>
              <div class="tool-meta">
                <span class="tool-tag">Narrative</span>
                <span class="tool-tag">Archive</span>
              </div>
            </article>
            <article class="tool-card">
              <h3>Map Library</h3>
              <p>Browse maps, attach encounter markers, and export for VTTs.</p>
              <div class="tool-meta">
                <span class="tool-tag">Exploration</span>
                <span class="tool-tag">VTT</span>
              </div>
            </article>
            <article class="tool-card">
              <h3>Downtime Planner</h3>
              <p>Schedule crafting, research, and settlement activities.</p>
              <div class="tool-meta">
                <span class="tool-tag">Kingdom</span>
                <span class="tool-tag">Crafting</span>
              </div>
            </article>
            <article class="tool-card">
              <h3>Rules Reference</h3>
              <p>Bookmark frequently used rules and house adjustments.</p>
              <div class="tool-meta">
                <span class="tool-tag">Rules</span>
                <span class="tool-tag">Quick</span>
              </div>
            </article>
          </div>
        </section>

        <!-- Right column panels for spotlight info -->
        <aside aria-label="GM status panels">
          <div class="side-panel">
            <h2>Active Threads</h2>
            <ul class="panel-list">
              <li class="panel-item">Resolve the midnight heist before sunrise.</li>
              <li class="panel-item">Track the cult envoy meeting on Day 3.</li>
              <li class="panel-item">Reveal the vault guardian's true motive.</li>
            </ul>
          </div>
          <div class="side-panel">
            <h2>Recent Updates</h2>
            <ul class="panel-list">
              <li class="panel-item">NPC "Captain Vale" promoted to ally status.</li>
              <li class="panel-item">Added 2 new traps to encounter library.</li>
              <li class="panel-item">Session recap shared with players.</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>

    <!-- Initiative tracker module (opens from the dashboard tool card) -->
    <section
      class="initiative-module is-hidden"
      id="initiative-module"
      aria-label="Initiative tracker module"
    >
      <div class="container">
        <div class="module-header">
          <h2>Initiative Tracker</h2>
          <p class="helper-text">
            Manage turn order, track conditions, and handle duration-based reminders in a focused
            workspace.
          </p>
          <div class="module-actions">
            <button id="initiative-back" class="ghost" type="button">
              ← Back to Dashboard
            </button>
          </div>
        </div>

        <section class="initiative-tracker" aria-label="Initiative tracker workspace">
          <p class="helper-text">
            Set up your encounter roster, gather initiative rolls in a lightbox prompt, and manage
            round-by-round conditions with automatic expiry reminders.
          </p>
          <div class="tracker-grid">
            <div class="tracker-panel">
              <h3>Encounter Setup</h3>
              <form id="participant-form">
                <div class="field-row">
                  <div>
                    <label for="participant-name">Participant name</label>
                    <input
                      id="participant-name"
                      name="participant-name"
                      type="text"
                      placeholder="e.g. Sir Garrick"
                      required
                    />
                  </div>
                  <div>
                    <label for="participant-type">Type</label>
                    <select id="participant-type" name="participant-type">
                      <option value="Player">Player</option>
                      <option value="Monster">Monster</option>
                    </select>
                  </div>
                  <div>
                    <button type="submit">Add</button>
                  </div>
                </div>
              </form>
              <div class="initiative-controls">
                <button id="start-encounter" class="secondary" disabled>Start Encounter</button>
                <span id="encounter-status" class="status-pill is-hidden">Encounter Active</span>
              </div>
              <p class="notice">
                Tip: Use the “Start Encounter” button to open the initiative lightbox and capture
                rolls for everyone in the roster.
              </p>
              <div class="legend">
                <span>Highlight = current turn</span>
                <span>Prompt = marker ready to expire</span>
              </div>
            </div>
            <div class="tracker-panel">
              <h3>Round Controls</h3>
              <p>
                <span class="round-display">Round:</span>
                <span id="round-count">1</span>
              </p>
              <p>
                <strong>Current:</strong>
                <span id="current-participant">Awaiting initiative...</span>
              </p>
              <div class="initiative-controls">
                <button id="previous-turn" class="ghost" disabled>Previous Turn</button>
                <button id="next-turn" disabled>Next Turn</button>
              </div>
              <p class="helper-text">
                Use “Next Turn” to advance. End-of-turn reminders will appear for expiring
                markers.
              </p>
            </div>
          </div>

          <div class="tracker-panel" style="margin-top: 1.5rem;">
            <h3>Participants</h3>
            <table class="participant-table" aria-label="Initiative order">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Initiative</th>
                  <th>Markers</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="participant-body">
                <tr>
                  <td colspan="5" class="helper-text">Add participants to begin building the encounter.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </section>

    <!-- Initiative input lightbox -->
    <div id="initiative-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <h3>Enter Initiative Rolls</h3>
        <p class="helper-text">
          Confirm each participant's initiative before starting the encounter.
        </p>
        <div id="initiative-list" class="modal-list"></div>
        <div class="modal-actions">
          <button id="initiative-cancel" class="ghost" type="button">Cancel</button>
          <button id="initiative-confirm" type="button">Begin Encounter</button>
        </div>
      </div>
    </div>

    <!-- Marker editor lightbox -->
    <div id="marker-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <h3>Add Marker</h3>
        <p class="helper-text">
          Add a condition or reminder with an optional duration. Duration is counted from the
          selected participant's turn.
        </p>
        <form id="marker-form">
          <div class="modal-list">
            <div>
              <label for="marker-target">Add marker to</label>
              <select id="marker-target" required></select>
            </div>
            <div>
              <label for="marker-condition">Preset condition (optional)</label>
              <select id="marker-condition"></select>
            </div>
            <div>
              <label for="marker-label">Custom label</label>
              <input
                id="marker-label"
                type="text"
                placeholder="e.g. Bless +1 morale"
              />
            </div>
            <div>
              <label for="marker-duration">Duration (rounds, optional)</label>
              <input
                id="marker-duration"
                type="number"
                min="1"
                placeholder="e.g. 3"
              />
            </div>
            <div>
              <label for="marker-start">Start counting on</label>
              <select id="marker-start" required></select>
            </div>
          </div>
          <div class="modal-actions">
            <button id="marker-cancel" class="ghost" type="button">Cancel</button>
            <button type="submit">Save Marker</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Marker expiry prompt lightbox -->
    <div id="expiry-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal">
        <h3>Marker Expiring</h3>
        <p id="expiry-message" class="helper-text"></p>
        <div class="modal-actions">
          <button id="expiry-keep" class="ghost" type="button">Keep</button>
          <button id="expiry-remove" type="button">Remove</button>
        </div>
      </div>
    </div>

    <!-- Footer for thematic close -->
    <footer>
      <div class="container">
        <p>Keep your notes close and your dice closer.</p>
      </div>
    </footer>

    <script>
      // ------------------------------
      // Initiative Tracker Logic
      // ------------------------------
      const conditionPresets = [
        "Blinded",
        "Confused",
        "Cowering",
        "Dazzled",
        "Dazed",
        "Deafened",
        "Entangled",
        "Exhausted",
        "Fatigued",
        "Fascinated",
        "Frightened",
        "Grappled",
        "Helpless",
        "Nauseated",
        "Panicked",
        "Paralyzed",
        "Petrified",
        "Pinned",
        "Prone",
        "Shaken",
        "Sickened",
        "Staggered",
        "Stunned",
        "Unconscious",
      ];

      const state = {
        participants: [],
        encounterStarted: false,
        round: 1,
        turnIndex: 0,
        promptQueue: [],
        pendingAdvance: false,
        editingTargetId: null,
      };

      // Cache DOM nodes once for performance and clarity.
      const participantForm = document.getElementById("participant-form");
      const participantName = document.getElementById("participant-name");
      const participantType = document.getElementById("participant-type");
      const startEncounterButton = document.getElementById("start-encounter");
      const encounterStatus = document.getElementById("encounter-status");
      const roundCount = document.getElementById("round-count");
      const currentParticipantLabel = document.getElementById("current-participant");
      const nextTurnButton = document.getElementById("next-turn");
      const previousTurnButton = document.getElementById("previous-turn");
      const participantBody = document.getElementById("participant-body");

      const initiativeModal = document.getElementById("initiative-modal");
      const initiativeList = document.getElementById("initiative-list");
      const initiativeCancel = document.getElementById("initiative-cancel");
      const initiativeConfirm = document.getElementById("initiative-confirm");

      const markerModal = document.getElementById("marker-modal");
      const markerForm = document.getElementById("marker-form");
      const markerTarget = document.getElementById("marker-target");
      const markerCondition = document.getElementById("marker-condition");
      const markerLabel = document.getElementById("marker-label");
      const markerDuration = document.getElementById("marker-duration");
      const markerStart = document.getElementById("marker-start");
      const markerCancel = document.getElementById("marker-cancel");

      const expiryModal = document.getElementById("expiry-modal");
      const expiryMessage = document.getElementById("expiry-message");
      const expiryKeep = document.getElementById("expiry-keep");
      const expiryRemove = document.getElementById("expiry-remove");

      // Module navigation elements keep the dashboard and tracker in separate views.
      const dashboardView = document.getElementById("dashboard-view");
      const initiativeModule = document.getElementById("initiative-module");
      const initiativeLaunch = document.getElementById("initiative-launch");
      const initiativeBack = document.getElementById("initiative-back");

      // Utility helpers keep state changes predictable and documented.
      const generateId = () => `id-${Math.random().toString(16).slice(2, 10)}`;

      const openModal = (modal) => {
        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
      };

      const closeModal = (modal) => {
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
      };

      // Toggle module visibility to keep the initiative tracker off the dashboard.
      const openInitiativeModule = () => {
        dashboardView.classList.add("is-hidden");
        initiativeModule.classList.remove("is-hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const closeInitiativeModule = () => {
        initiativeModule.classList.add("is-hidden");
        dashboardView.classList.remove("is-hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      const getCurrentParticipant = () => state.participants[state.turnIndex] || null;

      const getCurrentTurnNumber = () => {
        const total = state.participants.length || 1;
        return (state.round - 1) * total + state.turnIndex;
      };

      const getNextTurnNumberForParticipant = (participantId) => {
        const total = state.participants.length || 1;
        const index = state.participants.findIndex((participant) => participant.id === participantId);
        if (index < 0) {
          return getCurrentTurnNumber();
        }
        const currentTurnNumber = getCurrentTurnNumber();
        const currentRoundIndex = state.turnIndex;
        if (index >= currentRoundIndex) {
          return (state.round - 1) * total + index;
        }
        return state.round * total + index;
      };

      const updateEncounterControls = () => {
        const hasParticipants = state.participants.length > 0;
        startEncounterButton.disabled = !hasParticipants;
        nextTurnButton.disabled = !state.encounterStarted;
        previousTurnButton.disabled = !state.encounterStarted;
        encounterStatus.classList.toggle("is-hidden", !state.encounterStarted);
      };

      const updateRoundDisplay = () => {
        roundCount.textContent = state.round;
        const current = getCurrentParticipant();
        currentParticipantLabel.textContent = current
          ? `${current.name} (${current.type})`
          : "Awaiting initiative...";
      };

      const updateMarkerSelects = () => {
        const options = state.participants
          .map((participant) => `<option value="${participant.id}">${participant.name}</option>`)
          .join("");
        markerTarget.innerHTML = options;
        markerStart.innerHTML = options;
      };

      const renderParticipants = () => {
        if (!state.participants.length) {
          participantBody.innerHTML =
            '<tr><td colspan="5" class="helper-text">Add participants to begin building the encounter.</td></tr>';
          return;
        }

        participantBody.innerHTML = state.participants
          .map((participant, index) => {
            const markers = participant.markers
              .map((marker) => {
                const durationText = marker.duration
                  ? `(${marker.duration}r)`
                  : "(end of turn)";
                return `
                  <span class="marker-chip">
                    ${marker.label} ${durationText}
                    <button type="button" aria-label="Remove marker" data-remove-marker="${marker.id}">
                      ✕
                    </button>
                  </span>
                `;
              })
              .join("");

            return `
              <tr class="participant-row ${state.encounterStarted && index === state.turnIndex ? "active" : ""}">
                <td>${participant.name}</td>
                <td>${participant.type}</td>
                <td>${participant.initiative ?? "—"}</td>
                <td>
                  ${markers || "<span class=\"helper-text\">No markers</span>"}
                </td>
                <td>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                    <button type="button" class="secondary" data-add-marker="${participant.id}">
                      Add Marker
                    </button>
                    <button type="button" class="ghost" data-remove-participant="${participant.id}">
                      Remove
                    </button>
                  </div>
                </td>
              </tr>
            `;
          })
          .join("");
      };

      // Render the initiative lightbox list with inputs for each participant.
      const renderInitiativeModal = () => {
        initiativeList.innerHTML = state.participants
          .map((participant) => {
            return `
              <div class="modal-item">
                <div>
                  <strong>${participant.name}</strong>
                  <div class="helper-text">${participant.type}</div>
                </div>
                <div>
                  <label class="helper-text" for="initiative-${participant.id}">Initiative</label>
                  <input
                    id="initiative-${participant.id}"
                    type="number"
                    inputmode="numeric"
                    min="-5"
                    value="${participant.initiative ?? ""}"
                  />
                </div>
              </div>
            `;
          })
          .join("");
      };

      const seedConditionPresets = () => {
        markerCondition.innerHTML = [
          '<option value="">-- Select condition --</option>',
          ...conditionPresets.map((preset) => `<option value="${preset}">${preset}</option>`),
        ].join("");
      };

      // Initialize baseline UI.
      seedConditionPresets();
      updateEncounterControls();
      updateRoundDisplay();

      // Wire module navigation events for the initiative tracker entry point.
      initiativeLaunch.addEventListener("click", openInitiativeModule);
      initiativeBack.addEventListener("click", closeInitiativeModule);

      participantForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const name = participantName.value.trim();
        const type = participantType.value;
        if (!name) {
          return;
        }
        state.participants.push({
          id: generateId(),
          name,
          type,
          initiative: null,
          markers: [],
        });
        participantName.value = "";
        renderParticipants();
        updateEncounterControls();
        updateMarkerSelects();
      });

      startEncounterButton.addEventListener("click", () => {
        if (!state.participants.length) {
          return;
        }
        renderInitiativeModal();
        openModal(initiativeModal);
      });

      initiativeCancel.addEventListener("click", () => {
        closeModal(initiativeModal);
      });

      initiativeConfirm.addEventListener("click", () => {
        state.participants = state.participants.map((participant) => {
          const input = document.getElementById(`initiative-${participant.id}`);
          const value = Number.parseInt(input.value, 10);
          return {
            ...participant,
            initiative: Number.isNaN(value) ? 0 : value,
          };
        });
        state.participants.sort((a, b) => {
          if (b.initiative !== a.initiative) {
            return b.initiative - a.initiative;
          }
          return a.name.localeCompare(b.name);
        });
        state.encounterStarted = true;
        state.round = 1;
        state.turnIndex = 0;
        closeModal(initiativeModal);
        renderParticipants();
        updateEncounterControls();
        updateRoundDisplay();
        updateMarkerSelects();
      });

      participantBody.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const removeId = target.getAttribute("data-remove-participant");
        const addMarkerId = target.getAttribute("data-add-marker");
        const removeMarkerId = target.getAttribute("data-remove-marker");

        if (removeId) {
          state.participants = state.participants.filter((participant) => participant.id !== removeId);
          if (state.turnIndex >= state.participants.length) {
            state.turnIndex = Math.max(0, state.participants.length - 1);
          }
          renderParticipants();
          updateEncounterControls();
          updateRoundDisplay();
          updateMarkerSelects();
          return;
        }

        if (addMarkerId) {
          state.editingTargetId = addMarkerId;
          updateMarkerSelects();
          markerTarget.value = addMarkerId;
          markerStart.value = addMarkerId;
          markerCondition.value = "";
          markerLabel.value = "";
          markerDuration.value = "";
          openModal(markerModal);
          return;
        }

        if (removeMarkerId) {
          state.participants = state.participants.map((participant) => ({
            ...participant,
            markers: participant.markers.filter((marker) => marker.id !== removeMarkerId),
          }));
          renderParticipants();
        }
      });

      markerCancel.addEventListener("click", () => {
        closeModal(markerModal);
      });

      markerForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const targetId = markerTarget.value;
        const startId = markerStart.value;
        const durationValue = markerDuration.value ? Number.parseInt(markerDuration.value, 10) : null;
        const conditionValue = markerCondition.value.trim();
        const customLabelValue = markerLabel.value.trim();
        const label = customLabelValue || conditionValue;
        if (!targetId || !startId || !label) {
          return;
        }

        const startTurnNumber = getNextTurnNumberForParticipant(startId);
        const total = state.participants.length || 1;
        const durationRounds = durationValue && durationValue > 0 ? durationValue : null;
        const endTurnNumber = durationRounds ? startTurnNumber + durationRounds * total : null;

        const marker = {
          id: generateId(),
          label,
          duration: durationRounds,
          startParticipantId: startId,
          startTurnNumber,
          endTurnNumber,
        };

        state.participants = state.participants.map((participant) => {
          if (participant.id !== targetId) {
            return participant;
          }
          return {
            ...participant,
            markers: [...participant.markers, marker],
          };
        });

        closeModal(markerModal);
        renderParticipants();
      });

      const queuePrompt = (participant, marker, reason) => {
        state.promptQueue.push({ participant, marker, reason });
      };

      const processPromptQueue = () => {
        if (!state.promptQueue.length) {
          closeModal(expiryModal);
          if (state.pendingAdvance) {
            completeTurnAdvance();
          }
          return;
        }
        const nextPrompt = state.promptQueue[0];
        const reasonText = nextPrompt.reason === "duration"
          ? "Duration complete"
          : "End of turn reminder";
        expiryMessage.textContent = `${reasonText}: Remove "${nextPrompt.marker.label}" from ${nextPrompt.participant.name}?`;
        openModal(expiryModal);
      };

      expiryKeep.addEventListener("click", () => {
        state.promptQueue.shift();
        processPromptQueue();
      });

      expiryRemove.addEventListener("click", () => {
        const { marker } = state.promptQueue.shift();
        state.participants = state.participants.map((participant) => ({
          ...participant,
          markers: participant.markers.filter((existing) => existing.id !== marker.id),
        }));
        renderParticipants();
        processPromptQueue();
      });

      const checkForExpiryPrompts = () => {
        const current = getCurrentParticipant();
        if (!current) {
          return;
        }
        const currentTurnNumber = getCurrentTurnNumber();
        current.markers.forEach((marker) => {
          if (!marker.duration) {
            queuePrompt(current, marker, "end-turn");
          }
        });
        state.participants.forEach((participant) => {
          participant.markers.forEach((marker) => {
            if (
              marker.duration &&
              marker.endTurnNumber !== null &&
              marker.startParticipantId === current.id &&
              marker.endTurnNumber === currentTurnNumber
            ) {
              queuePrompt(participant, marker, "duration");
            }
          });
        });
      };

      const completeTurnAdvance = () => {
        state.pendingAdvance = false;
        if (!state.participants.length) {
          return;
        }
        if (state.turnIndex < state.participants.length - 1) {
          state.turnIndex += 1;
        } else {
          state.turnIndex = 0;
          state.round += 1;
        }
        renderParticipants();
        updateRoundDisplay();
      };

      const completeTurnRewind = () => {
        if (!state.participants.length) {
          return;
        }
        if (state.turnIndex > 0) {
          state.turnIndex -= 1;
        } else if (state.round > 1) {
          state.round -= 1;
          state.turnIndex = state.participants.length - 1;
        }
        renderParticipants();
        updateRoundDisplay();
      };

      nextTurnButton.addEventListener("click", () => {
        if (!state.encounterStarted) {
          return;
        }
        state.promptQueue = [];
        checkForExpiryPrompts();
        if (state.promptQueue.length) {
          state.pendingAdvance = true;
          processPromptQueue();
          return;
        }
        completeTurnAdvance();
      });

      previousTurnButton.addEventListener("click", () => {
        if (!state.encounterStarted) {
          return;
        }
        completeTurnRewind();
      });
    </script>
  </body>
</html>
